<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PDF Quiz Generator</title>

<!-- ✅ PDF.js محلي بدل CDN -->
<script src="./vendor/pdfjs/pdf.min.js"></script>

<!-- Tesseract (بقي كما هو - إذا لاحقاً حجبته الشبكة منخليه محلي) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:white;
  padding:20px;
}
button{
  padding:10px 15px;
  margin:5px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#2563eb;color:white;}
.secondary{background:#475569;color:white;}
textarea{
  width:100%;
  min-height:150px;
  margin-top:10px;
  border-radius:8px;
  padding:10px;
}
.quiz-box{
  margin-top:20px;
  background:#1e293b;
  padding:15px;
  border-radius:10px;
}
.correct{color:#22c55e;}
.wrong{color:#ef4444;}
</style>
</head>

<body>

<h2>تحويل PDF إلى اختبار</h2>

<input type="file" id="pdfFile" accept="application/pdf">
<button class="primary" id="extractBtn">استخراج النص</button>
<button class="secondary" id="generateBtn">توليد اختبار</button>
<button class="secondary" id="gradeBtn">تصحيح</button>

<textarea id="outputText" placeholder="النص المستخرج..."></textarea>

<div id="quizContainer" class="quiz-box"></div>
<div id="result"></div>

<script>

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "./vendor/pdfjs/pdf.worker.min.js"; // ✅ محلي بدل CDN

const pdfInput = document.getElementById("pdfFile");
const extractBtn = document.getElementById("extractBtn");
const generateBtn = document.getElementById("generateBtn");
const gradeBtn = document.getElementById("gradeBtn");
const outputText = document.getElementById("outputText");
const quizContainer = document.getElementById("quizContainer");
const resultDiv = document.getElementById("result");

let extractedText = "";
let questions = [];

extractBtn.onclick = async () => {
  const file = pdfInput.files[0];
  if (!file) return alert("اختر ملف PDF أولاً");

  const reader = new FileReader();
  reader.onload = async function() {
    const typedarray = new Uint8Array(this.result);
    const pdf = await pdfjsLib.getDocument({data: typedarray}).promise;

    let fullText = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      const strings = content.items.map(item => item.str);
      fullText += strings.join(" ") + "\n";
    }

    extractedText = fullText;
    outputText.value = fullText;
  };
  reader.readAsArrayBuffer(file);
};

generateBtn.onclick = () => {
  if (!extractedText) return alert("استخرج النص أولاً");

  quizContainer.innerHTML = "";
  resultDiv.innerHTML = "";
  questions = [];

  const sentences = extractedText.split(".").filter(s => s.length > 40).slice(0,5);

  sentences.forEach((s, index) => {
    const q = {
      question: s.trim(),
      answer: "صح"
    };
    questions.push(q);

    const div = document.createElement("div");
    div.innerHTML = `
      <p>${index+1}) ${q.question}</p>
      <label><input type="radio" name="q${index}" value="صح"> صح</label>
      <label><input type="radio" name="q${index}" value="خطأ"> خطأ</label>
      <hr>
    `;
    quizContainer.appendChild(div);
  });
};

gradeBtn.onclick = () => {
  let score = 0;

  questions.forEach((q, index) => {
    const selected = document.querySelector(`input[name="q${index}"]:checked`);
    if (selected && selected.value === q.answer) {
      score++;
    }
  });

  const finalScore = Math.round((score / questions.length) * 100);
  resultDiv.innerHTML = `<h3>علامتك: ${finalScore} / 100</h3>`;
};

</script>

</body>
</html>
